#include <stdio.h>
#include <string.h>
#include <errno.h>
#include <stdlib.h>
#include <dlfcn.h>
#include <unistd.h>
#include <sys/mman.h>
#include <stdint.h>
#include <stdbool.h>
#include "libmaze.h"
static void * __stored_ptr = NULL;
maze_t *maze = NULL;
int idx = 0;
int got_table[1200] = {0x7d5f, 0x6f1f, 0x740f, 0x6537, 0x69bf, 0x81df, 0x866f, 0x7877, 0x7d2f, 0x7fb7, 0x7b07, 0x7677, 0x71b7, 0x6be7, 0x67ef, 0x636f, 0x8477, 0x7fe7, 0x7b2f, 0x8597, 0x8027, 0x7c3f, 0x7797, 0x72ef, 0x6e1f, 0x68ff, 0x64a7, 0x85a7, 0x8047, 0x788f, 0x73f7, 0x6e4f, 0x6a07, 0x658f, 0x869f, 0x820f, 0x7d3f, 0x78af, 0x7407, 0x7547, 0x705f, 0x6b67, 0x66cf, 0x87b7, 0x8327, 0x7e37, 0x7987, 0x7517, 0x700f, 0x846f, 0x7fd7, 0x7b47, 0x7697, 0x71c7, 0x6c7f, 0x67af, 0x6347, 0x842f, 0x7faf, 0x80cf, 0x7c4f, 0x779f, 0x72df, 0x6e07, 0x691f, 0x648f, 0x858f, 0x80bf, 0x7c0f, 0x6a1f, 0x6597, 0x8697, 0x81f7, 0x7d57, 0x7897, 0x73ef, 0x6ee7, 0x69d7, 0x656f, 0x831f, 0x7e2f, 0x797f, 0x750f, 0x7007, 0x6b3f, 0x66a7, 0x879f, 0x8317, 0x7d8f, 0x768f, 0x71bf, 0x6c77, 0x67a7, 0x633f, 0x8427, 0x7fa7, 0x7aff, 0x766f, 0x71af, 0x7207, 0x6cd7, 0x681f, 0x639f, 0x849f, 0x7ee7, 0x7a3f, 0x75bf, 0x70cf, 0x6bc7, 0x64e7, 0x85cf, 0x8107, 0x7c6f, 0x77b7, 0x730f, 0x6d1f, 0x685f, 0x63bf, 0x84d7, 0x78df, 0x7447, 0x6f57, 0x6a4f, 0x65df, 0x86c7, 0x822f, 0x7caf, 0x77ff, 0x7357, 0x6bd7, 0x6707, 0x87ff, 0x835f, 0x7e9f, 0x79f7, 0x756f, 0x706f, 0x6a7f, 0x6627, 0x7f87, 0x7af7, 0x7657, 0x7187, 0x6c67, 0x6797, 0x6317, 0x8417, 0x7f5f, 0x7ac7, 0x68d7, 0x6477, 0x856f, 0x80af, 0x7bff, 0x7747, 0x7297, 0x6d9f, 0x68b7, 0x6447, 0x73c7, 0x6ed7, 0x69a7, 0x653f, 0x861f, 0x81af, 0x7d07, 0x7867, 0x73af, 0x6ea7, 0x82ef, 0x7e0f, 0x795f, 0x74cf, 0x6fdf, 0x6aff, 0x667f, 0x8767, 0x82bf, 0x7def, 0x678f, 0x630f, 0x840f, 0x7f57, 0x7abf, 0x762f, 0x7157, 0x6c47, 0x6767, 0x62df, 0x80a7, 0x7bf7, 0x773f, 0x728f, 0x6d97, 0x68af, 0x643f, 0x8547, 0x808f, 0x7bd7, 0x72e7, 0x778f, 0x7c2f, 0x80d7, 0x8587, 0x6487, 0x68f7, 0x6de7, 0x71d7, 0x769f, 0x83d7, 0x62c7, 0x674f, 0x6c2f, 0x711f, 0x75f7, 0x7a6f, 0x7f27, 0x8397, 0x8827, 0x7497, 0x791f, 0x7dc7, 0x8297, 0x872f, 0x663f, 0x6ac7, 0x6f87, 0x746f, 0x78f7, 0x6987, 0x6e8f, 0x7387, 0x782f, 0x7ccf, 0x815f, 0x85ef, 0x64f7, 0x695f, 0x6e6f, 0x8077, 0x850f, 0x640f, 0x6887, 0x6d5f, 0x7237, 0x76ef, 0x7b87, 0x803f, 0x8507, 0x75ef, 0x7a67, 0x7f1f, 0x838f, 0x881f, 0x6717, 0x6bf7, 0x7117, 0x75df, 0x7a47, 0x828f, 0x8727, 0x6637, 0x6abf, 0x6f7f, 0x7467, 0x78ef, 0x7d97, 0x8287, 0x871f, 0x8157, 0x85e7, 0x64ef, 0x6957, 0x6e67, 0x737f, 0x781f, 0x7cbf, 0x8137, 0x8657, 0x687f, 0x6d57, 0x722f, 0x76e7, 0x7b7f, 0x8037, 0x84ff, 0x63f7, 0x686f, 0x6d2f, 0x66c7, 0x6b8f, 0x709f, 0x757f, 0x79d7, 0x7e87, 0x83cf, 0x62bf, 0x6747, 0x6c27, 0x72a7, 0x809f, 0x7be7, 0x645f, 0x855f, 0x6db7, 0x68c7, 0x7647, 0x717f, 0x7f77, 0x654f, 0x8637, 0x6ecf, 0x699f, 0x786f, 0x73bf, 0x81a7, 0x7d0f, 0x646f, 0x8567, 0x745f, 0x6f6f, 0x7d87, 0x78e7, 0x86d7, 0x8247, 0x6a57, 0x65f7, 0x7427, 0x6f2f, 0x8387, 0x6bdf, 0x670f, 0x758f, 0x70a7, 0x7ea7, 0x7a07, 0x87d7, 0x833f, 0x6b87, 0x801f, 0x7b77, 0x63af, 0x84b7, 0x6cef, 0x682f, 0x76b7, 0x71e7, 0x7ff7, 0x7b3f, 0x694f, 0x77cf, 0x732f, 0x811f, 0x7c7f, 0x64b7, 0x85b7, 0x6e2f, 0x6917, 0x77c7, 0x824f, 0x6a5f, 0x65ef, 0x741f, 0x6f27, 0x7d4f, 0x78a7, 0x86cf, 0x8237, 0x6a27, 0x7587, 0x70af, 0x7eaf, 0x79ff, 0x87cf, 0x8337, 0x6b7f, 0x66bf, 0x7577, 0x708f, 0x6827, 0x76af, 0x71df, 0x7fef, 0x7b37, 0x63a7, 0x84a7, 0x6ccf, 0x67ff, 0x772f, 0x8117, 0x7c77, 0x64af, 0x85af, 0x6e27, 0x690f, 0x77bf, 0x7317, 0x80ff, 0x7c57, 0x7057, 0x753f, 0x6787, 0x6c5f, 0x83ff, 0x62f7, 0x7adf, 0x7f6f, 0x7167, 0x7637, 0x868f, 0x7957, 0x7e07, 0x6fd7, 0x74c7, 0x668f, 0x6b07, 0x82d7, 0x876f, 0x7837, 0x6dff, 0x857f, 0x647f, 0x7c47, 0x80ef, 0x72d7, 0x7787, 0x69af, 0x6ec7, 0x8627, 0x7b1f, 0x7fcf, 0x71a7, 0x7687, 0x67f7, 0x6cbf, 0x8467, 0x6367, 0x7bef, 0x8097, 0x87af, 0x79c7, 0x7e7f, 0x704f, 0x7537, 0x677f, 0x6c57, 0x83f7, 0x62ef, 0x7ad7, 0x6f07, 0x73e7, 0x65a7, 0x6a17, 0x8207, 0x8687, 0x794f, 0x7dff, 0x6fcf, 0x74bf, 0x7377, 0x7817, 0x68a7, 0x6d87, 0x851f, 0x642f, 0x7bbf, 0x806f, 0x725f, 0x7717, 0x63ef, 0x7a97, 0x7f3f, 0x7137, 0x761f, 0x673f, 0x6c17, 0x83c7, 0x62b7, 0x7aaf, 0x7a4f, 0x7f17, 0x710f, 0x75d7, 0x6667, 0x6af7, 0x82a7, 0x874f, 0x790f, 0x7db7, 0x6ab7, 0x827f, 0x8717, 0x7857, 0x7cff, 0x6e9f, 0x739f, 0x6507, 0x697f, 0x817f, 0x6fff, 0x6caf, 0x67e7, 0x6357, 0x8457, 0x7fc7, 0x7b0f, 0x767f, 0x719f, 0x6a77, 0x7ae7, 0x763f, 0x716f, 0x6c6f, 0x679f, 0x631f, 0x841f, 0x80df, 0x7c1f, 0x7777, 0x6dc7, 0x68cf, 0x644f, 0x854f, 0x80b7, 0x7c07, 0x7757, 0x729f, 0x6f0f, 0x69ef, 0x6ebf, 0x69cf, 0x655f, 0x8647, 0x81c7, 0x7e6f, 0x79b7, 0x7527, 0x702f, 0x6b57, 0x877f, 0x82e7, 0x7e27, 0x7977, 0x74ef, 0x6ff7, 0x6ca7, 0x67df, 0x634f, 0x844f, 0x6397, 0x8497, 0x7edf, 0x7a37, 0x75b7, 0x70df, 0x6bbf, 0x66f7, 0x880f, 0x8377, 0x7307, 0x6d17, 0x6857, 0x63c7, 0x84cf, 0x8017, 0x7b6f, 0x76d7, 0x7227, 0x6dd7, 0x6a47, 0x65d7, 0x86bf, 0x8227, 0x7ca7, 0x77f7, 0x734f, 0x6e5f, 0x6947, 0x64d7, 0x79ef, 0x7567, 0x7077, 0x6a87, 0x661f, 0x86e7, 0x825f, 0x7d7f, 0x78cf, 0x7457, 0x71ff, 0x6cdf, 0x6817, 0x638f, 0x848f, 0x7ed7, 0x7a2f, 0x75af, 0x70d7, 0x6bb7, 0x712f, 0x7607, 0x7a7f, 0x7f37, 0x836f, 0x87e7, 0x66e7, 0x6b97, 0x7097, 0x754f, 0x873f, 0x664f, 0x6ad7, 0x6f67, 0x7437, 0x78bf, 0x7d67, 0x823f, 0x86a7, 0x65b7, 0x7cdf, 0x816f, 0x85df, 0x64c7, 0x6937, 0x6e47, 0x7327, 0x77a7, 0x7c5f, 0x80f7, 0x6d6f, 0x7217, 0x76c7, 0x7b5f, 0x8007, 0x84af, 0x6377, 0x6807, 0x6cc7, 0x71cf, 0x628f, 0x672f, 0x6bff, 0x7127, 0x75ff, 0x7a77, 0x7f2f, 0x8367, 0x87df, 0x66df, 0x6f97, 0x747f, 0x78ff, 0x7d9f, 0x829f, 0x8737, 0x6647, 0x6acf, 0x6f5f, 0x742f, 0x6e77, 0x738f, 0x783f, 0x7cd7, 0x8167, 0x85d7, 0x64bf, 0x692f, 0x6e3f, 0x731f, 0x7b97, 0x804f, 0x8517, 0x6417, 0x688f, 0x6d67, 0x720f, 0x76bf, 0x7b57, 0x7fff, 0x7b17, 0x7fbf, 0x832f, 0x87bf, 0x66b7, 0x6b77, 0x7047, 0x752f, 0x79bf, 0x7e77, 0x6b47, 0x6f17, 0x73ff, 0x789f, 0x7d47, 0x81ef, 0x8677, 0x6587, 0x69ff, 0x6e17, 0x70bf, 0x7ebf, 0x7a17, 0x62a7, 0x83af, 0x6c07, 0x6727, 0x75e7, 0x70f7, 0x7ef7, 0x6cff, 0x683f, 0x7707, 0x724f, 0x805f, 0x7ba7, 0x6407, 0x84ef, 0x6d37, 0x6867, 0x7c8f, 0x651f, 0x8607, 0x6e87, 0x696f, 0x7827, 0x735f, 0x813f, 0x7cb7, 0x6467, 0x6f47, 0x7d6f, 0x78b7, 0x86df, 0x8257, 0x6a6f, 0x65ff, 0x748f, 0x6f8f, 0x7da7, 0x87ef, 0x834f, 0x6b9f, 0x66d7, 0x7597, 0x70b7, 0x7eb7, 0x7a0f, 0x629f, 0x83a7, 0x7b4f, 0x63b7, 0x84bf, 0x6cf7, 0x6837, 0x76ff, 0x7247, 0x8057, 0x7b9f, 0x63ff, 0x6e37, 0x6927, 0x77df, 0x7337, 0x8127, 0x7c87, 0x6517, 0x85ff, 0x6e7f, 0x6967, 0x6b0f, 0x6687, 0x73cf, 0x6edf, 0x7d1f, 0x787f, 0x862f, 0x81b7, 0x69b7, 0x6547, 0x7acf, 0x8787, 0x82f7, 0x6b1f, 0x669f, 0x74df, 0x6fe7, 0x7e17, 0x7967, 0x86f7, 0x6457, 0x8557, 0x6dbf, 0x68bf, 0x764f, 0x7177, 0x7f7f, 0x7aef, 0x62ff, 0x8407, 0x6eff, 0x73df, 0x659f, 0x6a0f, 0x81ff, 0x867f, 0x7947, 0x7df7, 0x6fc7, 0x74b7, 0x736f, 0x780f, 0x689f, 0x6d7f, 0x852f, 0x6427, 0x7bb7, 0x8067, 0x7257, 0x770f, 0x63e7, 0x7a8f, 0x7f4f, 0x7147, 0x7617, 0x6737, 0x6c0f, 0x83bf, 0x62af, 0x7aa7, 0x7a5f, 0x7f0f, 0x7107, 0x75cf, 0x665f, 0x6aef, 0x82b7, 0x8747, 0x7907, 0x7daf, 0x6aaf, 0x8277, 0x870f, 0x784f, 0x7cf7, 0x6e97, 0x7397, 0x64ff, 0x6977, 0x8177, 0x650f, 0x7cc7, 0x814f, 0x7367, 0x7807, 0x6897, 0x6d77, 0x8527, 0x641f, 0x7baf, 0x7267, 0x76f7, 0x6877, 0x6d4f, 0x84f7, 0x63df, 0x7a87, 0x7f47, 0x713f, 0x760f, 0x6c1f, 0x83b7, 0x6297, 0x7a57, 0x7f07, 0x70ff, 0x75c7, 0x6657, 0x6ae7, 0x82af, 0x7917, 0x7dbf, 0x6f9f, 0x7487, 0x662f, 0x6aa7, 0x826f, 0x8707, 0x7847, 0x7cef, 0x6907, 0x6e0f, 0x859f, 0x649f, 0x7c37, 0x80e7, 0x72cf, 0x777f, 0x68ef, 0x6ddf, 0x6eb7, 0x69c7, 0x6557, 0x863f, 0x81bf, 0x7e67, 0x79af, 0x751f, 0x7027, 0x6b5f, 0x8777, 0x82df, 0x7e1f, 0x796f, 0x74e7, 0x6fef, 0x6cb7, 0x67d7, 0x635f, 0x8447, 0x6387, 0x8487, 0x7ecf, 0x7a27, 0x75a7, 0x70ef, 0x6baf, 0x66ef, 0x8807, 0x837f, 0x72ff, 0x6d0f, 0x684f, 0x63d7, 0x84e7, 0x800f, 0x7b67, 0x76cf, 0x721f, 0x6dcf, 0x6a3f, 0x65cf, 0x86b7, 0x821f, 0x7c9f, 0x77ef, 0x7347, 0x6e57, 0x693f, 0x64cf, 0x79e7, 0x755f, 0x707f, 0x6a8f, 0x6617, 0x86ef, 0x8267, 0x7d77, 0x78c7, 0x744f, 0x71f7, 0x6ce7, 0x680f, 0x637f, 0x847f, 0x7ec7, 0x7a1f, 0x759f, 0x70e7, 0x6ba7, 0x64df, 0x85c7, 0x810f, 0x7c67, 0x77af, 0x72f7, 0x6d07, 0x6847, 0x63cf, 0x84df, 0x78d7, 0x743f, 0x6f4f, 0x6a37, 0x65c7, 0x86af, 0x8217, 0x7c97, 0x77e7, 0x733f, 0x6bcf, 0x66ff, 0x87f7, 0x8357, 0x7e97, 0x79df, 0x7557, 0x7087, 0x6a97, 0x660f, 0x6677, 0x875f, 0x82cf, 0x7de7, 0x793f, 0x74d7, 0x6fb7, 0x6b17, 0x6697, 0x86ff, 0x8187, 0x8347, 0x785f, 0x73a7, 0x6eaf, 0x6997, 0x652f, 0x8617, 0x8197, 0x7d17, 0x727f, 0x6d8f, 0x6f3f, 0x6437, 0x8537, 0x8087, 0x7bdf, 0x774f, 0x7287, 0x6daf, 0x675f, 0x62e7, 0x83e7, 0x85bf, 0x7a9f, 0x7627, 0x715f, 0x6c4f, 0x6777, 0x6307, 0x7dcf, 0x7927, 0x74af, 0x6fa7, 0x71ef, 0x666f, 0x8757, 0x82c7, 0x7ddf, 0x7937, 0x68e7, 0x6607, 0x853f, 0x807f, 0x7bc7, 0x7727, 0x7277, 0x6da7, 0x69e7, 0x6567, 0x77d7, 0x714f, 0x6c37, 0x6757, 0x62cf, 0x83df, 0x7f67, 0x7c17, 0x775f, 0x72bf, 0x87a7, 0x830f, 0x7e47, 0x7997, 0x749f, 0x6faf, 0x6c8f, 0x67bf, 0x6337, 0x8437, 0x6ef7, 0x69df, 0x657f, 0x860f, 0x818f, 0x7e4f, 0x798f, 0x7507, 0x7017, 0x6b37, 0x776f, 0x72c7, 0x6df7, 0x6a67, 0x65e7, 0x865f, 0x81cf, 0x7d37, 0x7887, 0x73b7, 0x6d47, 0x6b2f, 0x8307, 0x8797, 0x79a7, 0x7e5f, 0x703f, 0x74ff, 0x66af, 0x6b6f, 0x7f97, 0x7197, 0x7667, 0x67cf, 0x6c9f, 0x845f, 0x632f, 0x7b27, 0x7fdf, 0x7067, 0x72af, 0x6a9f, 0x68df, 0x80c7, 0x8577, 0x7767, 0x7c27, 0x6def, 0x72b7, 0x6497, 0x81d7, 0x864f, 0x7eff, 0x7d27, 0x6eef, 0x73d7, 0x6577, 0x69f7, 0x81e7, 0x8667, 0x7e3f, 0x701f, 0x74f7, 0x6d3f, 0x6b27, 0x82ff, 0x878f, 0x799f, 0x7e57, 0x7037, 0x67b7, 0x6c87, 0x843f, 0x6327, 0x8147, 0x7f8f, 0x718f, 0x765f, 0x67c7, 0x6c97, 0x76a7, 0x7ce7, 0x6bef, 0x70c7, 0x8817, 0x671f, 0x7eef, 0x839f, 0x7737, 0x7bcf, 0x6adf, 0x802f, 0x84c7, 0x76df, 0x7b8f, 0x6d27, 0x723f, 0x6527, 0x698f, 0x819f, 0x6f37, 0x7417, 0x65bf, 0x6a2f, 0x812f, 0x85f7, 0x792f, 0x7dd7, 0x6fbf, 0x74a7, 0x87c7, 0x79cf, 0x7e8f, 0x6f77, 0x7477, 0x676f, 0x6c3f, 0x83ef, 0x62d7, 0x7ab7};
// maze: !=0 -> wall, ==0 -> path
int visited[_MAZE_MAXY][_MAZE_MAXX];
int *path; // 0: up, 1: down, 2: left, 3: right
int dir[4][2] = {{-1, 0}, {1, 0}, {0, -1}, {0, 1}};

int find_path(maze_t *mz, int x, int y) {
	if (x == mz->ex && y == mz->ey) {
		return 1;
	}
	visited[y][x] = 1;
	for (int i = 0; i < 4; i++) {
		int nx = x + dir[i][1];
		int ny = y + dir[i][0];
		if (nx < 0 || nx >= mz->w || ny < 0 || ny >= mz->h) {
			continue;
		}
		if (mz->blk[ny][nx] != 0 || visited[ny][nx] == 1) {
			continue;
		}
		path[idx++] = i;
		if (find_path(mz, nx, ny)) {
			return 1;
		}
		idx--;
	}
	return 0;
}

void print_maze(maze_t *mz) {
	printf("----------- MAZE -----------\n");
	for (int y = 0; y < mz->h; y++) {
		for (int x = 0; x < mz->w; x++) {
			if (mz->sx == x && mz->sy == y) {
				printf("S");
			} else if (mz->ex == x && mz->ey == y) {
				printf("E");
			} else if (mz->blk[y][x] == 0) {
				printf(".");
			} else {
				printf("#");
			}
		}
		printf("\n");
	}
	printf("----------- END -----------\n");
}

int maze_init() {
	setbuf(stdout, NULL);
	fprintf(stdout, "UP112_GOT_MAZE_CHALLENGE\n");
	fprintf(stdout, "SOLVER: _main = %p\n", maze_get_ptr());
	__stored_ptr = maze_get_ptr();
	void *maze_ptr = maze_get_ptr();
	maze = maze_load("/maze.txt");
	path = (int*)malloc(sizeof(int) * maze->w * maze->h);
	memset(path, -1, sizeof(int) * maze->w * maze->h);
	idx = 0;
	memset(visited, 0, sizeof(visited));
	if (find_path(maze, maze->sx, maze->sy)) {
		fprintf(stderr, "MAZE: path found.\n");
	} else {
		fprintf(stderr, "MAZE: path not found.\n");
	}
	
	
	void* handle = dlopen("/libmaze.so", RTLD_LAZY);
	void* move_up = dlsym(handle, "move_up");
	void* move_down = dlsym(handle, "move_down");
	void* move_left = dlsym(handle, "move_left");
	void* move_right = dlsym(handle, "move_right");
	
	for (int i = 0; i < idx; i++) {
		long *ptr;
		ptr = (void*)maze_ptr + got_table[i];
		uint64_t* got_entry_to_modify = (uint64_t*)ptr;
		uintptr_t page_start = (uintptr_t)got_entry_to_modify & ~(uintptr_t)(getpagesize() - 1);

		if (mprotect((void *)page_start, getpagesize(), PROT_READ | PROT_WRITE) == -1) {
        perror("mprotect");
        return 1;
    	}
		switch (path[i]) {
			case 0: *got_entry_to_modify = (uint64_t)move_up; break;
			case 1: *got_entry_to_modify = (uint64_t)move_down; break;
			case 2: *got_entry_to_modify = (uint64_t)move_left; break;
			case 3: *got_entry_to_modify = (uint64_t)move_right; break;
		}

		if (mprotect((void *)page_start, getpagesize(), PROT_READ) == -1) {
        perror("mprotect");
        return 1;
    	}
	}
	return 0;
}

